<!DOCTYPE html>
<html lang="zh">
<head>
    <title>系统管理</title>
    <meta charset="UTF-8">
    <link href="../static/css/common.css" rel="stylesheet">
    <link href="../static/css/admin.css" rel="stylesheet">
    <script src="../static/js/notification.js"></script>
    <script src="../static/js/common.js"></script>
    <script src="../static/js/admin.js"></script>
</head>
<body>
<div class="header">
    <h1>系统管理</h1>
    <div>
        <a class="btn btn-primary" href="{{ url_for('main.dashboard') }}">返回仪表板</a>
    </div>
</div>

<div class="container">
    <!-- 标签页导航 -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('users')">用户管理</div>
        <div class="tab" onclick="switchTab('machines')">机器管理</div>
        <div class="tab" onclick="switchTab('cleanup')">清理管理</div>
        <div class="tab" onclick="switchTab('system-config')">系统配置</div>
    </div>

    <!-- 用户管理标签页 -->
    <div class="tab-content active" id="users-tab">
        <div class="card">
            <h2>创建用户</h2>
            <form action="{{ url_for('admin.create_user') }}" method="POST">
                <div class="form-group">
                    <label>用户名:</label>
                    <input name="username" required type="text">
                </div>
                <div class="form-group">
                    <label>密码:</label>
                    <input name="password" required type="password">
                </div>
                <div class="form-group">
                    <label>邮箱:</label>
                    <input name="email" type="email">
                </div>
                <div class="form-group">
                    <label>
                        <input name="is_admin" type="checkbox"> 管理员权限
                    </label>
                </div>
                <button class="btn btn-success" type="submit">创建用户</button>
            </form>
        </div>

        <div class="card">
            <h2>用户管理</h2>
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>管理员</th>
                    <th>状态</th>
                    <th>最后登录</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email or '-' }}</td>
                    <td>{{ '是' if user.is_admin else '否' }}</td>
                    <td>{{ '激活' if user.is_active else '禁用' }}</td>
                    <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else '从未' }}</td>
                    <td>
                        {% if user.id != session.user_id %}
                        <button class="btn btn-warning"
                                onclick="confirmToggleUser({{ user.id }}, '{{ user.username }}', '{{ user.is_active }}', '{{ url_for('admin.toggle_user_status', user_id=user.id) }}')">
                            {{ '禁用' if user.is_active else '激活' }}
                        </button>
                        <button class="btn btn-danger"
                                onclick="confirmDeleteUser({{ user.id }}, '{{ user.username }}', '{{ url_for('admin.delete_user', user_id=user.id) }}')">
                            删除
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 机器管理标签页 -->
    <div class="tab-content" id="machines-tab">
        <div class="card">
            <!-- 机器统计信息显示区域 -->
            <div id="machineStats"></div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>机器列表</h2>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <!-- 显示选项 -->
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        <input type="checkbox" id="showInactiveCheckbox" onchange="loadMachines()">
                        <span>显示未激活机器</span>
                    </label>

                    <!-- 操作按钮组 -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-info btn-sm" onclick="refreshMachines()">🔄 刷新列表</button>
                        <button class="btn btn-warning btn-sm" onclick="showInactiveMachines()">👁️ 查看未激活</button>
                        <button class="btn btn-secondary btn-sm" onclick="showVmosMachinesList()">📋 VMOS机器</button>
                        <button class="btn btn-success btn-sm" onclick="syncNewMachines()">🔄 同步新机器</button>
                    </div>

                    <!-- 分隔线 -->
                    <div style="border-left: 1px solid #ddd; height: 30px;"></div>

                    <!-- 批量操作 -->
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="batchStartMachines()">⚡ 批量启动</button>
                        <button class="btn btn-danger btn-sm" onclick="batchStopMachines()">🛑 批量停止</button>
                    </div>
                </div>
            </div>

            <!-- 提示信息 -->
            <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">💡 机器管理说明</h4>
                <ul style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                    <li><strong>激活机器：</strong>只有激活的机器才会在仪表板下拉列表中显示</li>
                    <li><strong>未激活机器：</strong>被禁用的机器会从主列表隐藏，但可以通过"查看未激活"按钮重新激活</li>
                    <li><strong>显示选项：</strong>勾选"显示未激活机器"可以在主列表中看到所有机器</li>
                    <li><strong>批量操作：</strong>可以一次性激活多台未激活的机器</li>
                </ul>
            </div>

            <div id="machinesTable">
                <p>加载中...</p>
            </div>
        </div>
    </div>
</div>

<!-- 清理管理标签页 -->
<div class="tab-content" id="cleanup-tab">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>定时清理任务</h2>
            <div>
                <button class="btn btn-success" onclick="showAddCleanupTaskModal()">➕ 新增清理任务</button>
                <button class="btn btn-info" onclick="loadCleanupTasks()">🔄 刷新列表</button>
            </div>
        </div>
        <div id="cleanupTasksTable">
            <p>加载中...</p>
        </div>
    </div>
</div>

<!-- 添加清理任务模态框 -->
<div id="addCleanupTaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1004;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
        <h3>新增清理任务</h3>
        <form onsubmit="saveCleanupTask(event)">
            <input type="hidden" id="cleanupTaskId">

            <div class="form-group">
                <label>⏰ 执行时间:</label>
                <div class="time-input-wrapper" style="margin-top: 0.5rem;">
                    <input id="cleanupTaskTime" required type="time" value="03:00">
                </div>
                <span class="time-input-hint">24小时制</span>
            </div>

            <div class="form-group">
                <label>清理内容:</label>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="cleanupStatus" value="status"> 清理状态信息
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="cleanupLabel" value="label"> 清理标签信息
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="cleanupCounts" value="counts"> 重置运行次数
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>目标机器:</label>
                <select id="cleanupTargetConfigs" multiple style="height: 120px; margin-top: 0.5rem;">
                    <option value="">全部机器</option>
                </select>
                <small style="color: #666;">按住Ctrl可多选，不选表示全部机器</small>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input id="cleanupTaskEnabled" type="checkbox" checked> 启用任务
                </label>
            </div>

            <div style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="hideAddCleanupTaskModal()" style="margin-right: 1rem;" type="button">取消</button>
                <button class="btn btn-success" type="submit">保存任务</button>
            </div>
        </form>
    </div>
</div>

<!-- 消息详情模态框 -->
<div id="messageDetailModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px;">
        <h3 id="messageDetailTitle">消息详情</h3>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 1rem 0; max-height: 300px; overflow-y: auto;">
            <p id="messageDetailContent" style="white-space: pre-wrap; margin: 0; line-height: 1.5;"></p>
        </div>
        <div style="text-align: right;">
            <button class="btn btn-secondary" onclick="hideMessageDetail()">关闭</button>
        </div>
    </div>
</div>

<!-- 编辑机器模态框 -->
<div id="editMachineModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto;">
        <h3>编辑机器配置</h3>
        <form onsubmit="saveEditedMachine(event)">
            <input id="editMachineId" type="hidden">
            <input id="editMachineMessage" type="hidden">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>机器名称:</label>
                    <input id="editMachineName" required type="text">
                </div>
                <div class="form-group">
                    <label>机器代码:</label>
                    <input id="editMachineCode" required type="text">
                </div>
            </div>

            <div class="form-group">
                <label>描述:</label>
                <input id="editMachineDesc" type="text">
            </div>

            <!-- 多消息编辑区域 -->
            <div class="form-group">
                <div id="messagesContainer">
                    <!-- 消息列表将通过JavaScript动态生成 -->
                </div>

                <!-- 消息管理工具栏 -->
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; padding-top: 1rem; border-top: 1px solid #eee;">
                    <button type="button" class="btn btn-info btn-sm" onclick="showBatchImportModal()">📥 批量导入</button>
                    <button type="button" class="btn btn-warning btn-sm" onclick="clearAllMessages()">🗑️ 清空全部</button>
                    <span style="flex: 1;"></span>
                    <small style="color: #666; align-self: center;">
                        共 <span id="messageCount">${currentMessages.length}</span> 条消息
                    </small>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>成功时间范围 (秒) - 最小值:</label>
                    <input id="editSuccessTimeMin" min="1" required type="number">
                </div>
                <div class="form-group">
                    <label>成功时间范围 (秒) - 最大值:</label>
                    <input id="editSuccessTimeMax" min="1" required type="number">
                </div>
            </div>

            <div class="form-group">
                <label>重置时间 (小时):</label>
                <input id="editResetTime" min="0" type="number">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input id="editIsActive" type="checkbox"> 激活状态
                </label>
            </div>

            <div style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="hideEditMachineModal()" style="margin-right: 1rem;"
                        type="button">取消
                </button>
                <button class="btn btn-success" type="submit">保存更改</button>
            </div>
        </form>
    </div>
</div>


<div id="vmosMachinesModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1003;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 1000px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">🖥️ VMOS机器列表</h3>
            <button class="btn btn-secondary btn-sm" onclick="hideVmosMachinesModal()">✕ 关闭</button>
        </div>
        <div id="vmosMachinesContent">
            <!-- 内容将通过JavaScript动态加载 -->
        </div>
    </div>
</div>

<!-- 添加系统配置标签页内容 -->
<div class="tab-content" id="system-config-tab">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>系统配置管理</h2>
            <div>
                <button class="btn btn-info" onclick="loadSystemConfigs()">🔄 刷新配置</button>
            </div>
        </div>
        <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">⚠️ 重要提示</h4>
            <ul style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                <li>修改配置后需要重启应用才能生效</li>
                <li>敏感信息（如密钥、密码）在界面中会被隐藏</li>
                <li>建议在修改前先导出备份</li>
                <li>数据库和API相关配置请谨慎修改</li>
            </ul>
        </div>
        <div id="systemConfigsTable">
            <p>加载中...</p>
        </div>
    </div>
</div>

<!-- 添加/编辑系统配置模态框 -->
<div id="addSystemConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1005;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <h3>系统配置设置</h3>
        <form onsubmit="saveSystemConfig(event)">
            <input type="hidden" id="systemConfigId">

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>配置项名称 <span style="color: #dc3545;">*</span>:</label>
                    <input id="systemConfigKey" required type="text" placeholder="例如: DATABASE_URL" style="font-family: monospace;">
                    <small style="color: #6c757d;">通常为大写字母和下划线组成</small>
                </div>
                <div class="form-group">
                    <label>分类:</label>
                    <select id="systemConfigCategory">
                        <option value="general">通用配置</option>
                        <option value="database">数据库配置</option>
                        <option value="security">安全配置</option>
                        <option value="app">应用配置</option>
                        <option value="vmos">VMOS配置</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>配置值 <span style="color: #dc3545;">*</span>:</label>
                <textarea id="systemConfigValue" required rows="3" style="font-family: monospace; resize: vertical;" placeholder="请输入配置值"></textarea>
            </div>

            <div class="form-group">
                <label>描述说明:</label>
                <input id="systemConfigDescription" type="text" placeholder="简要描述此配置的用途">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input id="systemConfigSensitive" type="checkbox">
                    <span>🔒 敏感信息</span>
                    <small style="color: #6c757d; margin-left: 0.5rem;">(密码、密钥等敏感数据)</small>
                </label>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <strong>💡 配置类型说明：</strong>
                <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.9rem;">
                    <li><strong>数据库配置:</strong> DATABASE_URL 等数据库连接相关</li>
                    <li><strong>安全配置:</strong> SECRET_KEY, API_SECRET_TOKEN 等密钥</li>
                    <li><strong>应用配置:</strong> DEBUG, PKG_NAME 等应用设置</li>
                    <li><strong>VMOS配置:</strong> ACCESS_KEY, SECRET_ACCESS 等VMOS API</li>
                </ul>
            </div>

            <div style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="hideAddSystemConfigModal()" style="margin-right: 1rem;" type="button">取消</button>
                <button class="btn btn-success" type="submit">💾 保存配置</button>
            </div>
        </form>
    </div>
</div>

<!-- 未激活机器管理模态框 -->
<div id="inactiveMachinesModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1010;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 95%; max-width: 1200px; max-height: 85vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: #f57c00;">⚠️ 未激活机器管理</h3>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-info btn-sm" onclick="showInactiveMachines()">🔄 刷新列表</button>
                <button class="btn btn-secondary btn-sm" onclick="hideInactiveMachinesModal()">✕ 关闭</button>
            </div>
        </div>

        <!-- 警告提示 -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
            <strong>⚠️ 注意：</strong>
            <ul style="margin: 0.5rem 0 0 1rem;">
                <li>未激活的机器不会出现在仪表板的机器选择列表中</li>
                <li>激活机器后，它将重新出现在主管理界面和仪表板中</li>
                <li>您可以在激活前先编辑机器的配置信息</li>
                <li>删除操作将永久删除机器及其所有相关配置</li>
            </ul>
        </div>

        <div id="inactiveMachinesList">
            <!-- 未激活机器列表将在这里动态加载 -->
        </div>
    </div>
</div>
</body>
</html>