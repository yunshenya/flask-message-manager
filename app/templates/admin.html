<!DOCTYPE html>
<html lang="zh">
<head>
    <title>ç³»ç»Ÿç®¡ç†</title>
    <meta charset="UTF-8">
    <link href="../static/css/common.css" rel="stylesheet">
    <link href="../static/css/admin.css" rel="stylesheet">
    <script src="../static/js/notification.js"></script>
    <script src="../static/js/common.js"></script>
    <script src="../static/js/admin.js"></script>
</head>
<body>
<div class="header">
    <h1>ç³»ç»Ÿç®¡ç†</h1>
    <div>
        <a class="btn btn-primary" href="{{ url_for('main.dashboard') }}">è¿”å›ä»ªè¡¨æ¿</a>
    </div>
</div>

<div class="container">
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</div>
        <div class="tab" onclick="switchTab('machines')">æœºå™¨ç®¡ç†</div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
    <div class="tab-content active" id="users-tab">
        <div class="card">
            <h2>åˆ›å»ºç”¨æˆ·</h2>
            <form action="{{ url_for('admin.create_user') }}" method="POST">
                <div class="form-group">
                    <label>ç”¨æˆ·å:</label>
                    <input name="username" required type="text">
                </div>
                <div class="form-group">
                    <label>å¯†ç :</label>
                    <input name="password" required type="password">
                </div>
                <div class="form-group">
                    <label>é‚®ç®±:</label>
                    <input name="email" type="email">
                </div>
                <div class="form-group">
                    <label>
                        <input name="is_admin" type="checkbox"> ç®¡ç†å‘˜æƒé™
                    </label>
                </div>
                <button class="btn btn-success" type="submit">åˆ›å»ºç”¨æˆ·</button>
            </form>
        </div>

        <div class="card">
            <h2>ç”¨æˆ·ç®¡ç†</h2>
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>é‚®ç®±</th>
                    <th>ç®¡ç†å‘˜</th>
                    <th>çŠ¶æ€</th>
                    <th>æœ€åç™»å½•</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email or '-' }}</td>
                    <td>{{ 'æ˜¯' if user.is_admin else 'å¦' }}</td>
                    <td>{{ 'æ¿€æ´»' if user.is_active else 'ç¦ç”¨' }}</td>
                    <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'ä»æœª' }}</td>
                    <td>
                        {% if user.id != session.user_id %}
                        <button class="btn btn-warning"
                                onclick="confirmToggleUser({{ user.id }}, '{{ user.username }}', '{{ user.is_active }}', '{{ url_for('admin.toggle_user_status', user_id=user.id) }}')">
                            {{ 'ç¦ç”¨' if user.is_active else 'æ¿€æ´»' }}
                        </button>
                        <button class="btn btn-danger"
                                onclick="confirmDeleteUser({{ user.id }}, '{{ user.username }}', '{{ url_for('admin.delete_user', user_id=user.id) }}')">
                            åˆ é™¤
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- æœºå™¨ç®¡ç†æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="machines-tab">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>æœºå™¨åˆ—è¡¨</h2>
                <div>
                    <button class="btn btn-info" onclick="refreshMachines()">åˆ·æ–°åˆ—è¡¨</button>
                    <button class="btn btn-warning" onclick="showVmosMachinesList()">ğŸ“‹ æŸ¥çœ‹VMOSæœºå™¨</button>
                    <button class="btn btn-success" onclick="syncNewMachines()">ğŸ”„ åŒæ­¥æ–°æœºå™¨</button>
                    <hr style="margin: 0.5rem 0; border: none;">
                    <button class="btn btn-success" onclick="batchStartMachines()">æ‰¹é‡å¯åŠ¨</button>
                    <button class="btn btn-danger" onclick="batchStopMachines()">æ‰¹é‡åœæ­¢</button>
                </div>
            </div>
            <div id="machinesTable">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="messageDetailModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px;">
        <h3 id="messageDetailTitle">æ¶ˆæ¯è¯¦æƒ…</h3>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 1rem 0; max-height: 300px; overflow-y: auto;">
            <p id="messageDetailContent" style="white-space: pre-wrap; margin: 0; line-height: 1.5;"></p>
        </div>
        <div style="text-align: right;">
            <button class="btn btn-secondary" onclick="hideMessageDetail()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘æœºå™¨æ¨¡æ€æ¡† -->
<div id="editMachineModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <h3>ç¼–è¾‘æœºå™¨é…ç½®</h3>
        <form onsubmit="saveEditedMachine(event)">
            <input id="editMachineId" type="hidden">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>æœºå™¨åç§°:</label>
                    <input id="editMachineName" required type="text">
                </div>
                <div class="form-group">
                    <label>å‘é€çš„æ¶ˆæ¯:</label>
                    <input id="editMachineMessage" required type="text">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>æœºå™¨ä»£ç :</label>
                    <input id="editMachineCode" required type="text">
                </div>
                <div class="form-group">
                    <label>æè¿°:</label>
                    <input id="editMachineDesc" type="text">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>æˆåŠŸæ—¶é—´èŒƒå›´ (ç§’) - æœ€å°å€¼:</label>
                    <input id="editSuccessTimeMin" min="1" required type="number">
                </div>
                <div class="form-group">
                    <label>æˆåŠŸæ—¶é—´èŒƒå›´ (ç§’) - æœ€å¤§å€¼:</label>
                    <input id="editSuccessTimeMax" min="1" required type="number">
                </div>
            </div>

            <div class="form-group">
                <label>é‡ç½®æ—¶é—´ (å°æ—¶):</label>
                <input id="editResetTime" min="0" type="number">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input id="editIsActive" type="checkbox"> æ¿€æ´»çŠ¶æ€
                </label>
            </div>

            <div style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="hideEditMachineModal()" style="margin-right: 1rem;"
                        type="button">å–æ¶ˆ
                </button>
                <button class="btn btn-success" type="submit">ä¿å­˜æ›´æ”¹</button>
            </div>
        </form>
    </div>
</div>
<div id="vmosMachinesModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1003;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 1000px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">ğŸ–¥ï¸ VMOSæœºå™¨åˆ—è¡¨</h3>
            <button class="btn btn-secondary btn-sm" onclick="hideVmosMachinesModal()">âœ• å…³é—­</button>
        </div>
        <div id="vmosMachinesContent">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</div>
</body>
</html>